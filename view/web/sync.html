<div id="sync">
  <h1>Sync Package <span style="color:#09f;"><%= name %></span></h1>
  <div id="sync-notify">
    <div class="alert alert-success">Sync start, please wait patiently.</div>
  </div>
  <h2>Log</h2>
  <pre style="min-height: 400px;" id="sync-log"></pre>
</div>
<script>
  var $log = $('#sync-log');
  var $notify = $('#sync-notify');
  var timer;
  var name = '<%= name %>';
  $(function() {
    $.ajax({
      url: location.pathname,
      type: 'PUT',
      dataType: 'json',
      success: handleSyncSucess,
      error: function (err) {
        var alert = $('<div class="alert alert-error"></div>');
        var message = 'Sync request error.';
        if (err.status === 404) {
          message += 'Package ' + name + ' not exist in official registry.';
        }
        if (err.status === 500) {
          message += 'Please refresh to sync one more time.';
        }
        $notify.html('');
        alert.html(message);
        $notify.append(alert);
      }
    });
  });
  function handleSyncSucess(data) {
    if (data.ok) {
      timer = setInterval(getSyncLog.bind(null, data.logId), 2000);
      return;
    }
    $notify.html('<div class="alert alert-error">Sync request error.</div>');
  }

  var offset = 0;
  var logs = '';
  var successFlag = false;
  var failFlag = false;
  function getSyncLog(id) {
    $.ajax({
      url: location.pathname + '/log/' + id + '?offset=' + offset,
      type: 'GET',
      dataType: 'json',
      success: function (data) {
        if (!data.ok || !data.log) {
          return;
        }
        offset += data.log.split('\n').length;
        logs += data.log;

        if (data.log.indexOf('Success: [') >= 0) {
          successFlag = true;
        }
        if (data.log.indexOf('Fail: [') >= 0) {
          failFlag = true;
        }
        if (successFlag && failFlag) {
          logs += '\nSync package ' + name + ' complete!';
          clearInterval(timer);
        }
        $log.html(logs);
      }
    })
  }
</script>
